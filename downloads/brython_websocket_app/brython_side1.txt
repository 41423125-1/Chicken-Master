from browser import document, window, html, alert

# 全域變數
ws = None
messages_area = None
status_span = None

# 建立所有 UI 元件
def create_ui():
    global messages_area, status_span

    app = document["brython_div1"]
    app.clear()

    # 標題
    app <= html.H1("Brython + WebSocket 動態按鈕範例")

    # 輸入區
    input_div = html.DIV()
    input_div <= html.LABEL("輸入訊息: ", For="data")
    data_input = html.INPUT(id="data", type="text", placeholder="輸入要發送的訊息...")
    input_div <= data_input
    app <= input_div

    # 狀態顯示
    status_div = html.DIV(id="status")
    status_div <= "連接狀態: "
    status_span = html.SPAN("未連接", id="connection-status", style={"color": "red"})
    status_div <= status_span
    app <= status_div

    # 訊息顯示區
    messages_area = html.DIV(id="messages")
    app <= messages_area

    # 按鈕區
    btn_div = html.DIV(style={"margin-top": "15px"})

    # 發送按鈕（點擊後才連線並發送）
    run_btn = html.BUTTON("連線並發送", id="run", Class="btn btn-connect")
    run_btn.bind("click", connect_and_send)
    btn_div <= run_btn

    # 關閉按鈕
    close_btn = html.BUTTON("關閉連線", id="close", Class="btn btn-close")
    close_btn.bind("click", close_connection)
    btn_div <= close_btn

    app <= btn_div

# WebSocket 事件處理
def on_open(evt):
    status_span.text = "已連接"
    status_span.style.color = "green"
    add_message("WebSocket 連線成功！")

def on_message(evt):
    add_message(f"伺服器回應: {evt.data}")

def on_close(evt):
    add_message("連線已關閉")
    status_span.text = "已斷開"
    status_span.style.color = "red"

def on_error(evt):
    add_message(f"錯誤: {evt.message}")
    alert(f"WebSocket 錯誤: {evt.message}")

# 連線並發送訊息
def connect_and_send(evt):
    global ws
    data = document["data"].value.strip()

    if not data:
        alert("請輸入訊息！")
        return

    if ws and ws.readyState == ws.OPEN:
        # 已連線，直接發送
        ws.send(data)
        add_message(f"發送: {data}")
        document["data"].value = ""
    else:
        # 建立新連線
        try:
            ws = window.WebSocket.new("ws://localhost:8765")
            ws.bind("open", on_open)
            ws.bind("message", on_message)
            ws.bind("close", on_close)
            ws.bind("error", on_error)

            # 暫存訊息，等連線成功再發
            def send_after_open(e):
                ws.send(data)
                add_message(f"發送: {data}")
                document["data"].value = ""
                ws.unbind("open", send_after_open)  # 移除臨時事件

            ws.bind("open", send_after_open)

        except Exception as e:
            alert(f"連線失敗: {e}")

# 關閉連線
def close_connection(evt):
    global ws
    if ws and ws.readyState in (ws.CONNECTING, ws.OPEN):
        ws.close()
        ws = None
    else:
        add_message("無作用中連線")

# 新增訊息到顯示區
def add_message(msg):
    global messages_area
    messages_area.text += msg + "\n"
    messages_area.scrollTop = messages_area.scrollHeight

# 初始化
create_ui()