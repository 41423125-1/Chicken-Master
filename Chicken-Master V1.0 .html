<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>舒肥雞肉溫度與時間計算器（Brython）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* 簡潔樣式，保留核心 UI */
    :root{font-family: system-ui, "Noto Sans CJK TC", Arial, Helvetica, sans-serif}
    body{margin:0;background:#f5f7fb;color:#111;padding:16px;display:flex;justify-content:center}
    .card{width:100%;max-width:760px;background:#fff;border-radius:10px;padding:18px;box-shadow:0 6px 20px rgba(20,30,60,0.08)}
    h1{margin:0 0 8px;font-size:1.2rem}
    p.lead{margin:0 0 12px;color:#444;font-size:0.95rem}
    label{display:block;margin-top:10px;font-weight:600;color:#222}
    select,input[type="number"],input[type="text"]{width:100%;padding:8px 10px;margin-top:6px;border:1px solid #d6dbe6;border-radius:6px;background:#fff}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .btn{margin-top:12px;padding:10px 14px;background:#2b7cff;color:#fff;border:0;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.secondary{background:#6c757d}
    .recipe-buttons{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
    .recipe-btn{padding:8px;border-radius:8px;border:1px solid #d6dbe6;background:#fff;cursor:pointer;font-weight:700}
    .recipe-btn.active{background:#2b7cff;color:#fff;border-color:#2b7cff;box-shadow:0 4px 12px rgba(43,124,255,0.12)}
    .result{margin-top:14px;padding:12px;border-radius:8px;background:#f3f7ff;border:1px solid #dbe9ff}
    .marinade-details{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .marinade-item{background:#fff;padding:8px;border-radius:8px;border:1px solid #edf2ff;text-align:center}
    .marinade-name{font-size:0.85rem;color:#666;margin-bottom:6px}
    .marinade-amount{font-weight:700;color:#111}
    .warning{margin-top:12px;padding:10px;border-radius:8px;background:#fff6f6;border:1px solid #ffd6d6;color:#8a1b1b;font-size:0.9rem}
    small{color:#666}
  </style>

  <!-- Brython -->
  <script src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brython@3.10.5/brython_stdlib.js"></script>
</head>
<body onload="brython()">
  <div class="card">
    <h1>舒肥雞肉溫度與時間計算器</h1>
    <p class="lead">輸入雞肉重量，選擇目標溫度，估算到達核心溫度的加熱時間與保守保溫（滅菌）時間。可選配方並顯示醃料用量。</p>

    <div id="weight_block">
      <label>雞肉重量（公克）
        <input id="weight" type="number" min="1" step="1" value="500">
      </label>
      <small>整塊去骨雞胸或雞腿重量。實際烹調時間受厚度影響為主（此處以重量估算厚度）。</small>
    </div>

    <label>醃料配方（選一）
      <div class="recipe-buttons" id="recipe-buttons">
        <button class="recipe-btn active" id="recipe-classic">經典原味</button>
        <button class="recipe-btn" id="recipe-spicy">香辣風味</button>
        <button class="recipe-btn" id="recipe-herbal">香草蒜香</button>
        <button class="recipe-btn" id="recipe-sweet">蜜汁甜味</button>
      </div>
    </label>

    <label>目標熟度 / 溫度
      <select id="preset_temp">
        <option value="60">60 °C — 很嫩（需較長保溫以滅菌）</option>
        <option value="64">64 °C — 多汁</option>
        <option value="68">68 °C — 經典熟度</option>
        <option value="74">74 °C — USDA 建議即時安全</option>
        <option value="custom">自訂溫度</option>
      </select>
    </label>

    <div id="custom_temp_div" style="display:none">
      <label>自訂溫度（°C）
        <input id="custom_temp" type="number" min="40" max="100" step="0.1" value="62.0">
      </label>
    </div>

    <label>備註（可選）
      <input id="note" type="text" placeholder="例如：去骨雞胸、有皮、小塊切片">
    </label>

    <div class="row" style="margin-top:8px">
      <div class="col"><button id="calc" class="btn">計算時間與溫度</button></div>
      <div class="col"><button id="show-marinade" class="btn secondary">顯示醃料配方</button></div>
    </div>

    <div id="out" class="result" style="display:none"></div>

    <div id="marinade_panel" style="display:none" class="result">
      <div style="font-weight:700;color:#2b7cff">醃料用量建議</div>
      <div id="marinade-summary" style="margin-top:8px;color:#444">請先輸入重量並選擇配方，按「顯示醃料配方」或「計算時間與溫度」。</div>
      <div id="marinade-details" class="marinade-details"></div>
    </div>

    <div class="warning">
      <strong>安全提醒：</strong>
      <ul style="margin:6px 0 0 18px;padding:0">
        <li>USDA 建議雞肉中心溫度達 74°C 即時安全。</li>
        <li>較低溫度可用「溫度 × 時間」達到等效滅菌，請參考專業 pasteurization 表（如 Douglas Baldwin）。</li>
        <li>本工具僅為估算，請以官方或專業資料為準。</li>
      </ul>
    </div>
  </div>

  <script type="text/python">
from browser import document, html
import math

# 參數
DENSITY_G_PER_CM3 = 1.06   # 雞肉密度近似 g/cm^3
ALPHA = 1.4e-7             # 熱擴散係數 m^2/s（近似）
PI = math.pi

# 目前配方（字串）
current_recipe = "classic"

# 配方名稱字典（避免在 f-string 中內嵌字面大括號造成解析問題）
recipe_names = {
    "classic": "經典原味",
    "spicy": "香辣風味",
    "herbal": "香草蒜香",
    "sweet": "蜜汁甜味"
}

def set_active_recipe(recipe_id):
    global current_recipe
    # 清除所有 active 樣式
    for btn_id in ("recipe-classic","recipe-spicy","recipe-herbal","recipe-sweet"):
        document[btn_id].classList.remove("active")
    # 設定新的
    if recipe_id == "classic":
        document["recipe-classic"].classList.add("active")
        current_recipe = "classic"
    elif recipe_id == "spicy":
        document["recipe-spicy"].classList.add("active")
        current_recipe = "spicy"
    elif recipe_id == "herbal":
        document["recipe-herbal"].classList.add("active")
        current_recipe = "herbal"
    elif recipe_id == "sweet":
        document["recipe-sweet"].classList.add("active")
        current_recipe = "sweet"

def estimate_thickness_cm_from_weight_g(w_g):
    vol_cm3 = w_g / DENSITY_G_PER_CM3
    edge_cm = vol_cm3 ** (1/3)
    shape_factor = 0.6
    return max(0.2, edge_cm * shape_factor)

def estimate_time_to_reach_core_minutes(thickness_cm):
    half_m = (thickness_cm / 100.0) / 2.0
    t_char_s = (half_m ** 2) / (PI**2 * ALPHA)
    conservative_factor = 2.5
    t_s = t_char_s * conservative_factor
    return t_s / 60.0

def recommend_hold_minutes(temp_c):
    if temp_c >= 74:
        return 0
    if temp_c >= 70:
        return 2
    if temp_c >= 65:
        return 5
    if temp_c >= 60:
        return 20
    if temp_c >= 57:
        return 40
    return 60

def format_minutes(m):
    if m < 1:
        return f"{m*60:.0f} 秒"
    else:
        hrs = int(m // 60)
        mins = int(round(m % 60))
        if hrs > 0:
            return f"{hrs} 小時 {mins} 分鐘"
        else:
            return f"{int(round(m))} 分鐘"

def calculate_marinade(weight, recipe_type):
    if recipe_type == "classic":
        return {
            "salt": round(weight * 0.015, 1),      # g
            "pepper": round(weight * 0.005, 1),    # g
            "garlic": math.ceil(weight / 500),     # cloves
            "olive_oil": round(weight * 0.02, 1),  # ml
            "herbs": math.ceil(weight / 1000)      # tsp
        }
    elif recipe_type == "spicy":
        return {
            "salt": round(weight * 0.012, 1),
            "pepper": round(weight * 0.008, 1),
            "garlic": math.ceil(weight / 400),
            "olive_oil": round(weight * 0.018, 1),
            "chili_powder": round(weight * 0.003, 1),
            "paprika": round(weight * 0.002, 1)
        }
    elif recipe_type == "herbal":
        return {
            "salt": round(weight * 0.014, 1),
            "pepper": round(weight * 0.004, 1),
            "garlic": math.ceil(weight / 300),
            "olive_oil": round(weight * 0.025, 1),
            "rosemary": math.ceil(weight / 800),
            "thyme": math.ceil(weight / 800),
            "lemon_juice": round(weight * 0.01, 1)
        }
    elif recipe_type == "sweet":
        return {
            "salt": round(weight * 0.01, 1),
            "pepper": round(weight * 0.003, 1),
            "garlic": math.ceil(weight / 600),
            "olive_oil": round(weight * 0.015, 1),
            "honey": round(weight * 0.03, 1),
            "soy_sauce": round(weight * 0.02, 1)
        }

def create_marinade_details(marinade_data):
    details = document["marinade-details"]
    details.clear()
    for ingredient, amount in marinade_data.items():
        item = document.createElement("div")
        item.className = "marinade-item"
        name = document.createElement("div")
        name.className = "marinade-name"
        name.text = ingredient.replace("_"," ").title()
        val = document.createElement("div")
        val.className = "marinade-amount"
        if ingredient == "garlic":
            val.text = f"{amount} 顆"
        elif ingredient in ("olive_oil","lemon_juice","soy_sauce"):
            val.text = f"{amount} ml"
        elif ingredient in ("herbs","rosemary","thyme"):
            val.text = f"{amount} tsp"
        elif ingredient == "honey":
            val.text = f"{amount} g"
        else:
            val.text = f"{amount} g"
        item <= name
        item <= val
        details <= item

def on_preset_change(ev=None):
    val = document["preset_temp"].value
    document["custom_temp_div"].style.display = "block" if val == "custom" else "none"

def on_calc(ev=None):
    try:
        w = float(document["weight"].value)
        if w <= 0:
            raise ValueError("重量需為正數")

        thickness_cm = estimate_thickness_cm_from_weight_g(w)
        source = f"估算自重量 {w:.0f} g"

        preset = document["preset_temp"].value
        if preset == "custom":
            temp_c = float(document["custom_temp"].value)
        else:
            temp_c = float(preset)

        heat_minutes = estimate_time_to_reach_core_minutes(thickness_cm)
        hold_minutes = recommend_hold_minutes(temp_c)
        total_minutes = heat_minutes + hold_minutes

        out = document["out"]
        out.style.display = "block"
        out.clear()
        out <= html.H3("計算結果")
        out <= html.P(f"{source}；估算厚度：{thickness_cm:.2f} cm")
        out <= html.P(f"目標溫度：{temp_c:.1f} °C")
        out <= html.P(f"估計到達核心接近水浴溫度所需時間（保守估）： {format_minutes(heat_minutes)}")
        if hold_minutes == 0:
            out <= html.P(html.STRONG("建議保溫時間：即時/無需額外保溫（USDA 74°C 推薦即時安全）"))
        else:
            out <= html.P(f"建議保溫（滅菌）時間（保守）： {format_minutes(hold_minutes)}（僅供參考）")
        out <= html.P(html.STRONG(f"估計總烹調時間（到達 + 保溫）： {format_minutes(total_minutes)}"))
        out <= html.HR()
        out <= html.P("備註：此為估算，測量實際厚度並直接輸入會更準確。")

        # 同時產生醃料建議（依目前選定配方）
        marinade_data = calculate_marinade(w, current_recipe)
        # 使用 recipe_names 字典取代內嵌大括號表達式，避免解析錯誤
        document["marinade-summary"].text = f"配方：{ recipe_names.get(current_recipe, current_recipe) } — 建議用量如下："
        create_marinade_details(marinade_data)
        document["marinade_panel"].style.display = "block"

    except Exception as e:
        out = document["out"]
        out.style.display = "block"
        out.clear()
        out <= html.P(f"發生錯誤：{e}")

def on_show_marinade(ev=None):
    try:
        w = float(document["weight"].value)
        if w <= 0:
            raise ValueError("重量需為正數")
        marinade_data = calculate_marinade(w, current_recipe)
        document["marinade-summary"].text = f"配方：{ recipe_names.get(current_recipe, current_recipe) } — 建議用量如下："
        create_marinade_details(marinade_data)
        document["marinade_panel"].style.display = "block"
    except Exception as e:
        # 顯示錯誤於 out 區塊
        out = document["out"]
        out.style.display = "block"
        out.clear()
        out <= html.P(f"發生錯誤：{e}")

# 綁定事件
document["preset_temp"].bind("change", on_preset_change)
document["calc"].bind("click", on_calc)
document["show-marinade"].bind("click", on_show_marinade)

# 配方按鈕綁定
document["recipe-classic"].bind("click", lambda ev: set_active_recipe("classic"))
document["recipe-spicy"].bind("click", lambda ev: set_active_recipe("spicy"))
document["recipe-herbal"].bind("click", lambda ev: set_active_recipe("herbal"))
document["recipe-sweet"].bind("click", lambda ev: set_active_recipe("sweet"))
  </script>
</body>
</html>